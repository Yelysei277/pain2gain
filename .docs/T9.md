# T9 ‚Äî Real Reddit API Integration

**Goal:**  
Replace mock Reddit data with real API calls to fetch live posts from target subreddits.

---

## üçÄ Deliverables

- Reddit API credentials setup
- Updated `reddit-source.ts` to fetch from Reddit API
- Rate limiting and error handling
- Fallback mechanism to cached/mock data

---

## üõ† Steps

1. **Set up Reddit API credentials:**
   
   a. **Create a Reddit account** (if you don't have one):
      - Sign up at [reddit.com](https://www.reddit.com)
   
   b. **Register your application:**
      - Go to [reddit.com/prefs/apps](https://www.reddit.com/prefs/apps)
      - Scroll down and click **"create another app"** or **"create app"**
      - Fill in the form:
        - **Name**: `Pain2Gain` (or your app name)
        - **App type**: Select **"script"** (for server-side use)
        - **Description**: Brief description of your app
        - **Redirect URI**: For script apps, use `http://localhost:8080` (not used but required)
        - **About URL**: Optional
      - Click **"create app"**
   
   c. **Get your credentials:**
      - After creation, you'll see your app listed
      - The **client ID** is the string under your app name (looks like: `abc123def456ghi`)
      - The **client secret** is the "secret" field (looks like: `xyz789_secret_key_here`)
      - **Important**: Copy these immediately - the secret is only shown once!
   
   d. **Add credentials to environment:**
      - Add to `.env.local`:
        ```
        REDDIT_CLIENT_ID=<your-client-id>
        REDDIT_CLIENT_SECRET=<your-client-secret>
        REDDIT_USER_AGENT=Pain2Gain/1.0 (by /u/yourusername)
        ```
      - Replace `yourusername` with your actual Reddit username
      - User-Agent format: `AppName/Version (by /u/username)`

2. **Install Reddit API client (optional):**
   - Option A: Use `snoowrap` library: `npm i snoowrap` (easier, but adds dependency)
   - Option B: Use native `fetch` with OAuth2 token (recommended, no extra deps)

3. **Implement OAuth2 Client Credentials flow:**
   
   Reddit uses OAuth2. For server-side scripts, use the "client credentials" grant type:
   
   ```ts
   // Token cache to avoid unnecessary requests
   let cachedToken: { token: string; expiresAt: number } | null = null;
   
   async function getRedditAccessToken(): Promise<string> {
     // Return cached token if still valid (with 5 min buffer)
     if (cachedToken && cachedToken.expiresAt > Date.now() + 5 * 60 * 1000) {
       return cachedToken.token;
     }
     
     const clientId = process.env.REDDIT_CLIENT_ID;
     const clientSecret = process.env.REDDIT_CLIENT_SECRET;
     const userAgent = process.env.REDDIT_USER_AGENT;
     
     if (!clientId || !clientSecret || !userAgent) {
       throw new Error('Missing Reddit API credentials in environment variables');
     }
     
     // Create Basic Auth header (base64 encode client_id:client_secret)
     const auth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
     
     try {
       const response = await fetch('https://www.reddit.com/api/v1/access_token', {
         method: 'POST',
         headers: {
           'Authorization': `Basic ${auth}`,
           'Content-Type': 'application/x-www-form-urlencoded',
           'User-Agent': userAgent,
         },
         body: 'grant_type=client_credentials',
       });
       
       if (!response.ok) {
         const errorText = await response.text();
         throw new Error(`Reddit API auth failed: ${response.status} ${errorText}`);
       }
       
       const data = await response.json();
       
       // Cache token (expires in 1 hour, but we'll refresh after 55 min)
       cachedToken = {
         token: data.access_token,
         expiresAt: Date.now() + (data.expires_in - 300) * 1000, // 5 min buffer
       };
       
       return data.access_token;
     } catch (error) {
       throw new Error(`Failed to get Reddit access token: ${error instanceof Error ? error.message : 'Unknown error'}`);
     }
   }
   ```

4. **Update `loadRedditPosts()` function to fetch from Reddit API:**
   
   ```ts
   // Keep the old function as fallback
   async function loadRedditPostsFromFile(): Promise<RedditPost[]> {
     const { promises: fs } = await import('node:fs');
     const path = await import('node:path');
     const dataFilePath = path.join(process.cwd(), 'data', 'reddit-mock.json');
     const fileBuffer = await fs.readFile(dataFilePath, 'utf-8');
     const parsed = JSON.parse(fileBuffer) as RedditPost[];
     return parsed;
   }
   
   export async function loadRedditPosts(
     subreddits: string[] = ['startups', 'entrepreneur', 'SaaS'],
     limit: number = 100
   ): Promise<RedditPost[]> {
     try {
       const token = await getRedditAccessToken();
       const userAgent = process.env.REDDIT_USER_AGENT!;
       const allPosts: RedditPost[] = [];
       
       // Fetch from each subreddit
       for (const subreddit of subreddits) {
         try {
           // Remove 'r/' prefix if present
           const subredditName = subreddit.replace(/^r\//, '');
           
           // Fetch hot posts (can also use /new.json, /top.json, etc.)
           const response = await fetch(
             `https://oauth.reddit.com/r/${subredditName}/hot.json?limit=${limit}`,
             {
               headers: {
                 'Authorization': `Bearer ${token}`,
                 'User-Agent': userAgent,
               },
             }
           );
           
           // Check rate limit headers
           const rateLimitRemaining = response.headers.get('x-ratelimit-remaining');
           const rateLimitReset = response.headers.get('x-ratelimit-reset');
           
           if (rateLimitRemaining && parseInt(rateLimitRemaining) < 10) {
             console.warn(`Reddit API rate limit low: ${rateLimitRemaining} requests remaining`);
           }
           
           if (!response.ok) {
             console.warn(`Failed to fetch from r/${subredditName}: ${response.status} ${response.statusText}`);
             continue;
           }
           
           const data = await response.json();
           
           // Transform Reddit API response to our RedditPost format
           const posts: RedditPost[] = data.data.children.map((child: any) => {
             const post = child.data;
             return {
               id: post.id,
               subreddit: `r/${post.subreddit}`,
               title: post.title,
               body: post.selftext || '', // selftext is empty for link posts
               upvotes: post.ups,
               num_comments: post.num_comments,
               created_utc: post.created_utc,
             };
           });
           
           allPosts.push(...posts);
           
           // Small delay to respect rate limits
           await new Promise(resolve => setTimeout(resolve, 1000));
         } catch (subredditError) {
           console.error(`Error fetching r/${subreddit}:`, subredditError);
           // Continue with other subreddits
         }
       }
       
       if (allPosts.length === 0) {
         throw new Error('No posts fetched from Reddit API');
       }
       
       return allPosts;
     } catch (error) {
       console.error('Reddit API error, falling back to mock data:', error);
       // Fallback to mock data
       return loadRedditPostsFromFile();
     }
   }
   ```

5. **Add rate limiting:**
   - Reddit API allows 60 requests per minute per client
   - Implement simple rate limiter or use a library like `bottleneck`
   - Cache access tokens (they expire after 1 hour)

6. **Update API route `/api/generate`:**
   - Ensure it uses the new `loadRedditPosts()` function
   - Handle API failures gracefully

7. **Test with real subreddits:**
   - Verify posts are fetched correctly
   - Check that fallback works when API is unavailable

---

## üí° Notes

### Rate Limits
- **OAuth2 apps**: 60 requests per minute
- **Unauthenticated**: 30 requests per minute
- Check `X-Ratelimit-Remaining` and `X-Ratelimit-Reset` headers in responses
- Implement delays between requests to stay within limits

### Token Management
- Access tokens expire after **1 hour**
- Implement token caching (as shown above) to avoid unnecessary auth requests
- Refresh tokens before expiration (with 5-10 min buffer)

### API Endpoints
- Base URL: `https://oauth.reddit.com` (authenticated) or `https://www.reddit.com` (public)
- Common endpoints:
  - `/r/{subreddit}/hot.json` - Hot posts
  - `/r/{subreddit}/new.json` - New posts
  - `/r/{subreddit}/top.json` - Top posts
  - Query params: `?limit=100`, `?after={fullname}` for pagination

### Error Handling
- Always implement fallback to mock data
- Handle 429 (rate limit), 401 (auth), 403 (forbidden) errors gracefully
- Some subreddits may be private or restricted

### Alternatives
- **Pushshift API**: Historical data, no auth required, but may be slower/less reliable
- **Reddit JSON endpoints**: Public endpoints like `https://www.reddit.com/r/{subreddit}/hot.json` (no auth, but stricter rate limits)

### Best Practices
- Cache fetched posts in database (`sources` table) to reduce API calls
- Store post metadata (id, created_utc) to avoid duplicates
- Consider background jobs to fetch posts periodically
- Keep `loadRedditPostsFromFile()` as fallback for development/testing

