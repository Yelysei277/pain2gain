# T13 â€” Auth-Gated Feed & Functionality

**Goal:**
Ensure the ideas feed and all related actions (generation, subscriptions, notifications) are only accessible after the user signs in.

---

## ğŸ€ Deliverables

- Auth guard on the landing feed (`/`) and any other idea-related routes.
- API endpoints return `401 Unauthorized` for unauthenticated requests where appropriate.
- Redirect logic that sends anonymous users to `/auth`, optionally with a return URL.
- Documentation updates describing the gated flow.

---

## ğŸ›  Steps

1. **Evaluate current routing:**
   - Identify publicly accessible pages/components that should now require authentication (e.g., `HomePage`, `FeedClient`).
   - Determine whether the landing hero should remain public or if the entire experience is gated.
2. **Implement guard:**
   - Use server components (`createServerComponentClient`) or middleware to check for a session before rendering.
   - For client-only components, verify session state and show a loader/redirect if unauthenticated.
3. **Secure APIs:**
   - Confirm `/api/ideas`, `/api/generate`, `/api/subscriptions`, and `/api/notifications/*` enforce auth.
   - Return consistent JSON errors when unauthenticated.
4. **Update navigation:**
   - Ensure nav links donâ€™t expose restricted pages to logged-out users.
   - Optionally display a call-to-action encouraging login/signup.
5. **Docs & QA:**
   - Record the new behavior in `.docs/T13.md` (this file) and update README if needed.
   - Test the flow in both authenticated and anonymous states to verify redirects.

---

## ğŸ’¡ Notes

- Consider using Next.js middleware for a single source of truth if multiple routes need guarding.
- Maintain a good user experience by showing a friendly message before redirecting.
- Ensure the unsubscribe page stays public since itâ€™s used by email recipients.

---

## âœ… Implementation Summary

- Added `src/middleware.ts` to enforce authentication on `/`, `/app/*`, and idea-related API routes, returning a `401` JSON payload for API callers or redirecting browsers to `/auth?redirect=...`.
- Updated server components (`src/app/page.tsx`, `src/app/app/profile/page.tsx`, root layout) to verify Supabase sessions before rendering and to carry the return URL through redirects.
- Enhanced client auth flows so login links always include the current location and the `/auth` form redirects the user back to the requested page after successful sign-in.
- Hardened `/api/ideas`, `/api/generate`, and `/api/notifications/send-digest` handlers with session checks and consistent unauthorized responses.

## ğŸ” Protected Surface Area

- Pages: `/` (feed), `/app/profile`, and any route under `/app` now require a Supabase session; `/unsubscribe` remains public.
- APIs: `/api/ideas`, `/api/generate`, `/api/subscriptions/*`, and `/api/notifications/*` all demand a valid session. Unsubscribe endpoints stay publicly accessible for email recipients.

## ğŸ§ª QA Notes

- Anonymous visit to `/` or `/app/profile` âœ redirected to `/auth?redirect=...`.
- After signing in, users are returned to their original destination and navigation reveals the Ideas feed link.
- Unauthenticated POSTs to `/api/generate` or `/api/notifications/send-digest` return `401 { "error": "Unauthorized" }`.
- Unsubscribe flow (`/unsubscribe`, `/api/unsubscribe`) remains publicly reachable.
